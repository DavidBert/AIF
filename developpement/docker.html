<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Practical session 2 - AI Frameworks</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/docco.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../index.html">AI Frameworks</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../index.html" class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Courses</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Development tools for Data Scientist</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="course.html" class="dropdown-item">Course slides</a>
</li>
            
<li>
    <a href="git_intro.html" class="dropdown-item">Introduction to Git</a>
</li>
            
<li>
    <a href="pytorch.html" class="dropdown-item">Introduction to Pytorch</a>
</li>
            
<li>
    <a href="api.html" class="dropdown-item">Introduction to REST APIs</a>
</li>
            
<li>
    <a href="mnist.html" class="dropdown-item">Practical session 1</a>
</li>
            
<li>
    <a href="docker.html" class="dropdown-item active" aria-current="page">Practical session 2</a>
</li>
            
<li>
    <a href="quizz.html" class="dropdown-item">Quizz</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Recommender systems</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../rec_sys/rec_sys.html" class="dropdown-item">Course and practical session</a>
</li>
            
<li>
    <a href="../rec_sys/quizz.html" class="dropdown-item">Quizz</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Introduction to Reinforcement Learning</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../rl/rl.html" class="dropdown-item">Course and practical session</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Interpretability</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../xai/interpretability.html" class="dropdown-item">Course and practical session</a>
</li>
            
<li>
    <a href="../xai/quizz.html" class="dropdown-item">Quizz</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Introduction to Natural Language Processing (NLP)</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../nlp/nlp.html" class="dropdown-item">Course and practical session</a>
</li>
            
<li>
    <a href="../nlp/quizz.html" class="dropdown-item">Quizz</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Out-of-Distribution and Anomaly Detection</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ood/ood.html" class="dropdown-item">Course and practical session</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Conformal Prediction</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../conformal/conformal.html" class="dropdown-item">Course and practical session</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/DavidBert/AIF" class="nav-link">Github repository</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="mnist.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="quizz.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#development-for-data-scientist" class="nav-link">Development for Data Scientist:</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#docker" class="nav-link">Docker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#api-container" class="nav-link">API container</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gradio-container" class="nav-link">Gradio container</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#docker-compose" class="nav-link">Docker compose</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="development-for-data-scientist">Development for Data Scientist:</h1>
<h2 id="docker">Docker</h2>
<!-- ## Course (Video by Brendan Guillouet)
<iframe width="560" height="315" src="https://www.youtube.com/embed/loMf5bFyzY4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe> -->

<!-- *   [Slides](https://github.com/wikistat/AI-Frameworks/tree/master/slides/Code_Development_Docker.pdf) -->

<!-- <!-- ## Practical Session -->

<p>In this practical session, you will now learn how to run your code through a Docker container.<br />
Using docker in data science projects has two advantages:  </p>
<ul>
<li>Improving the reproducibility of the results  </li>
<li>Facilitating the portability and deployment  </li>
</ul>
<p>In this session, we will try to package the code from our Gradio applications, allowing us to predict digits labels and to colorize images into a Docker image.<br />
We will then use this image to instantiate a container that could be hosted on any physical device to run the app.<br />
Make sure to have finished the <a href="mnist.html">previous practical session</a> before starting this one.</p>
<p>To make our full application work, we want to package both the Gradio application and the API into a two containers.<br />
To do so, we will create two Dockerfiles, one for the API and one for the Gradio application.<br />
We will then use docker-compose to run both the API and the Gradio application in a single container.</p>
<p>This is the plan, but it's easier to make and test both containers separately when debugging.
We will then create independent containers for each application and test them separately and then we will use docker-compose to run them together.<br />
Let's start by creating the Dockerfile corresponding to the API.  </p>
<h2 id="api-container">API container</h2>
<h3 id="requirements">Requirements</h3>
<p>Our API just need the following packages: <code>torch</code>, <code>torchvision</code>, <code>flask</code>, <code>pillow</code>, <code>numpy</code>.
Create a new file named <code>requirements-api.txt</code> containing the following code:</p>
<pre><code class="language-python">torch==2.0.1
torchvision==0.15.2
flask==2.3.2
pillow==10.0.0
numpy==1.24.4
</code></pre>
<p>It is a good practice to specify the version of the packages you are using to make sure to get the same environment eveytime you build the image.</p>
<h4 id="dockerfile">Dockerfile</h4>
<p>We will first create the Dockerfile corresponding to our environment.  </p>
<p>On your local machine, create a new file named <code>Dockerfile-api</code> containing the following code (update the path to the model file if needed):</p>
<pre><code class="language-python"># Use an official Python runtime as the parent image
FROM python:3.10-slim

# Set the working directory in the container to /app
WORKDIR /app


# Copy the current directory contents into the container at /app
COPY . /app

# Install any needed packages specified in requirements.txt
RUN pip install --trusted-host pypi.python.org -r requirements-api.txt

# Make port 5075 available to the world outside this container
EXPOSE 5075

# Define environment variable for Flask to run in production mode
ENV FLASK_ENV=production

# Run mnist_api.py when the container launches
CMD [&quot;python&quot;, &quot;mnist_api.py&quot;, &quot;--model_path&quot;, &quot;weights/mnist_net.pth&quot;]
</code></pre>
<p>Take a moment to analyze this dockerfile.<br />
As you can see, it is built upon an existing image with python 3.10.<br />
Starting from existing images allows for fast prototyping. You may find existing images on <a href="https://hub.docker.com/">DockerHub</a>.<br />
The python 3.10 image we will be using is available <a href="https://hub.docker.com/_/python">here</a>.<br />
You can have a look at its corresponding dockerfile <a href="https://github.com/docker-library/python/blob/093598a0190ba9074b899d6a0a21a00c859aac56/3.10/slim-trixie/Dockerfile">here</a>.<br />
Remmeber that docker images are organized by layers.  This  means that our image will be built upon the python 3.10 image and will contain all the dependencies you could find in the base image.  </p>
<h4 id="api-image">API Image</h4>
<p>If docker is not already installed in your machine, follow <a href="https://docs.docker.com/engine/install/">this guide</a> to install it.</p>
<p>You may now build your first image using the following command:</p>
<pre><code class="language-bash">sudo docker build -f Dockerfile-api -t mnist-flask-app .
</code></pre>
<p><code>-f</code> is used to specify the Dockerfile to use.<br />
<code>-t</code> is used to specify the name of the image.<br />
<code>.</code> is used to specify the context of the build. In our case, the context is the current directory.</p>
<p>The image should take a few minutes to build.<br />
Once it is done, use the following command to list the available images on your device:</p>
<pre><code class="language-console">sudo docker image ls
</code></pre>
<p>How many images can you see? What do they refer to?  </p>
<p>If you remember, this is not the ideal way to build a dockerfile.  If we need to modify our code, we will have to rebuild the image and it will be re-downloaded all the dependencies.
Try to add a comment in the <code>mnist_api.py</code> file with an empty line and to rebuild the image.<br />
This is probably quite long. 
Try to solve this problem by moving the part where you install the dependencies to the Dockerfile.  </p>
<h4 id="api-container_1">API Container</h4>
<p>Now that our images are built, we can use them to instantiate containers.
Since a container is an instance of an image, we can instantiate several containers using a single image.</p>
<p>We will run our first container using the interactive mode.</p>
<p>Run the following command to run your fist container:</p>
<pre><code class="language-bash">sudo docker run --rm -p 5075:5075 --name mnist mnist-flask-app
</code></pre>
<p><code>-p</code> is used to specify the port mapping.  This means that the container port 5075 (the port on which the API is running) will be accessible on port 5075 of the host machine.
<code>--rm</code> is used to remove the container when it stops. This is useful to avoid leaving orphaned containers behind.
<code>--name</code> is used to specify the name of the container.
<code>mnist-flask-app</code> is the name of the image we built in the previous step.
<code>mnist</code> is the name of the container.</p>
<p>On a separate terminal, you can list all your running containers using the following command:</p>
<pre><code class="language-console">sudo docker container ls
</code></pre>
<p>Quit the container using <code>ctrl+c</code>.</p>
<p>Your container is closed and does not appear when you list all the containers.</p>
<p>Restart a container using the following command:</p>
<pre><code class="language-bash">sudo docker run --rm -p 5075:5075 --name mnist mnist-flask-app
</code></pre>
<p>We will now test the API from the container.
If everything is working, you should be able to request your API using the notebook <code>test_api.ipynb</code>.
Check that everything is working is OK.</p>
<h2 id="gradio-container">Gradio container</h2>
<h3 id="requirements_1">Requirements</h3>
<p>Our Gradio application just need the following packages: <code>pillow</code>, <code>gradio</code>, <code>numpy</code>.
Create a new file named <code>requirements-gradio.txt</code> containing the following code:</p>
<pre><code class="language-python">pillow==10.3.0
gradio==5.49
numpy==1.26.4
</code></pre>
<h4 id="dockerfile_1">Dockerfile</h4>
<p>We will now create the Dockerfile corresponding to our environment.  </p>
<p>On your local machine, create a new file named <code>Dockerfile-gradio</code> containing the following code:</p>
<pre><code class="language-bash">FROM python:3.10-slim

WORKDIR /app

COPY requirements_gradio.txt .
RUN pip install --no-cache-dir -r requirements_gradio.txt

# App code
COPY . /app

# Gradio uses 7860 by default
EXPOSE 7860

# Immediate logging without -t
ENV PYTHONUNBUFFERED=1

# (FLASK_ENV isn't used by Gradio; safe to drop)
# ENV FLASK_ENV=production

CMD [&quot;python&quot;, &quot;mnist_gradio.py&quot;]

</code></pre>
<p>Take a moment to analyze this dockerfile.  </p>
<h4 id="gradio-image">Gradio Image</h4>
<p>Let's modify a little bit the gradio application to use the API from the localhost.
To do so, we need to change the base URL for API requests in the <code>mnist_gradio.py</code> file.
Change the following line:</p>
<pre><code class="language-python">response = requests.post(&quot;http://:5075/predict&quot;, data=img_binary.getvalue())
</code></pre>
<p>to</p>
<pre><code class="language-python">response = requests.post(&quot;http://host.docker.internal:5075/predict&quot;, data=img_binary.getvalue())
</code></pre>
<p>By doing so, the API will be accessible to the container from the host machine.</p>
<p>Now you can build the image using the following command:</p>
<pre><code class="language-bash">sudo docker build -f Dockerfile-gradio -t mnist-gradio-app .
</code></pre>
<h4 id="gradio-container_1">Gradio Container</h4>
<p>Once the image is built, you can run the container using the following command:</p>
<pre><code class="language-bash">sudo docker run --rm -p 7860:7860 --name mnist mnist-gradio-app
</code></pre>
<p>On another terminal, run the API locally and check that the Gradio application is working (<code>http://localhost:7860</code>):</p>
<pre><code class="language-bash">python mnist_api.py
</code></pre>
<h2 id="docker-compose">Docker compose</h2>
<p>At this point, we have two containers running well independently.<br />
It's time to run them together.
To do so, we will use docker-compose.
Create a new file named <code>docker-compose.yml</code> containing the following code:</p>
<pre><code class="language-yaml">version: '3.8' # specify docker-compose version
services: # services to run
  api: # name of the first service
    build: 
      context: . # specify the directory of the Dockerfile
      dockerfile: Dockerfile-api # specify the Dockerfile name
    ports:
      - &quot;5075:5075&quot; # specify port mapping

  gradio-app:
    build:
      context: . # specify the directory of the Dockerfile
      dockerfile: Dockerfile-gradio # specify the Dockerfile name
    ports:
      - &quot;7860:7860&quot; # specify port mapping
    depends_on:
      - api # specify service dependencies
</code></pre>
<p>We are creating two services:
- <code>api</code>: the API service
- <code>gradio-app</code>: the Gradio application service
The <code>depends_on</code> directive is used to specify that the Gradio application service depends on the API service.<br />
This means that the Gradio application service will not start until the API service is running.  </p>
<p>Both containers are exposed on the host machine on the ports 5075 and 7860 and will be able to communicate with each other.
Thus let's revert the change we made in the <code>mnist_gradio.py</code> file to use the API from the localhost.
Change the following line:</p>
<pre><code class="language-python">response = requests.post(&quot;http://host.docker.internal:5075/predict&quot;, data=img_binary.getvalue())
</code></pre>
<p>to</p>
<pre><code class="language-python">response = requests.post(&quot;http://0.0.0.0:5075/predict&quot;, data=img_binary.getvalue())
</code></pre>
<p>To run the application, run the following command:</p>
<pre><code class="language-bash">sudo docker-compose up
</code></pre>
<p>If everything is working, you should be able to access the Gradio application at <code>http://localhost:7860</code>.
To delete the containers, run the following command:</p>
<pre><code class="language-bash">sudo docker-compose down
</code></pre>
<p>That's it! Now you have a dockerized application that you can deploy on any machine that has docker installed.  </p>
<p>Do not hesitate to play a little more with Docker.<br />
For instance try to train the MNIST classifier directly in your container and to collect the tensorboard logs and the resulting weights on your local machine. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../javascripts/mathjax.js"></script>
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
